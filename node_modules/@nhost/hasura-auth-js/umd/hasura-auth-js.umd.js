(function(k,p){typeof exports=="object"&&typeof module<"u"?p(exports,require("@nhost/core")):typeof define=="function"&&define.amd?define(["exports","@nhost/core"],p):(k=typeof globalThis<"u"?globalThis:k||self,p(k["@nhost/hasura-auth-js"]={},k.core))})(this,function(k,p){"use strict";var _t=Object.defineProperty;var Tt=(k,p,j)=>p in k?_t(k,p,{enumerable:!0,configurable:!0,writable:!0,value:j}):k[p]=j;var pe=(k,p,j)=>(Tt(k,typeof p!="symbol"?p+"":p,j),j);function j(t){this.message=t}j.prototype=new Error,j.prototype.name="InvalidCharacterError";var ye=typeof window<"u"&&window.atob&&window.atob.bind(window)||function(t){var e=String(t).replace(/=+$/,"");if(e.length%4==1)throw new j("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,n,i=0,s=0,o="";n=e.charAt(s++);~n&&(r=i%4?64*r+n:n,i++%4)?o+=String.fromCharCode(255&r>>(-2*i&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return o};function Le(t){var e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(r){return decodeURIComponent(ye(r).replace(/(.)/g,function(n,i){var s=i.charCodeAt(0).toString(16).toUpperCase();return s.length<2&&(s="0"+s),"%"+s}))}(e)}catch{return ye(e)}}function Y(t){this.message=t}function Ue(t,e){if(typeof t!="string")throw new Y("Invalid token specified");var r=(e=e||{}).header===!0?0:1;try{return JSON.parse(Le(t.split(".")[r]))}catch(n){throw new Y("Invalid token specified: "+n.message)}}Y.prototype=new Error,Y.prototype.name="InvalidTokenError";/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var g=function(){return g=Object.assign||function(e){for(var r,n=1,i=arguments.length;n<i;n++){r=arguments[n];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},g.apply(this,arguments)};function De(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(t);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(t,n[i])&&(r[n[i]]=t[n[i]]);return r}function P(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function M(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var n=r.call(t),i,s=[],o;try{for(;(e===void 0||e-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(f){o={error:f}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(o)throw o.error}}return s}function J(t,e,r){if(r||arguments.length===2)for(var n=0,i=e.length,s;n<i;n++)(s||!(n in e))&&(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return t.concat(s||Array.prototype.slice.call(e))}var b;(function(t){t.Start="xstate.start",t.Stop="xstate.stop",t.Raise="xstate.raise",t.Send="xstate.send",t.Cancel="xstate.cancel",t.NullEvent="",t.Assign="xstate.assign",t.After="xstate.after",t.DoneState="done.state",t.DoneInvoke="done.invoke",t.Log="xstate.log",t.Init="xstate.init",t.Invoke="xstate.invoke",t.ErrorExecution="error.execution",t.ErrorCommunication="error.communication",t.ErrorPlatform="error.platform",t.ErrorCustom="xstate.error",t.Update="xstate.update",t.Pure="xstate.pure",t.Choose="xstate.choose"})(b||(b={}));var F;(function(t){t.Parent="#_parent",t.Internal="#_internal"})(F||(F={}));var Me=b.Start,ge=b.Stop,ie=b.Raise,se=b.Send,je=b.Cancel;b.NullEvent;var we=b.Assign;b.After,b.DoneState;var me=b.Log,ze=b.Init;b.Invoke,b.ErrorExecution;var Se=b.ErrorPlatform,Ke=b.ErrorCustom,Je=b.Update,$e=b.Choose,Ge=b.Pure,Fe=".",be={},oe="xstate.guard",A=process.env.NODE_ENV==="production",Z;function xe(t,e,r){r===void 0&&(r=Fe);var n=Ee(t,r),i=Ee(e,r);return U(i)?U(n)?i===n:!1:U(n)?n in i:Object.keys(n).every(function(s){return s in i?xe(n[s],i[s]):!1})}function He(t,e){try{return H(t)?t:t.toString().split(e)}catch{throw new Error("'".concat(t,"' is not a valid state path."))}}function Xe(t){return typeof t=="object"&&"value"in t&&"context"in t&&"event"in t&&"_event"in t}function Ee(t,e){if(Xe(t))return t.value;if(H(t))return _e(t);if(typeof t!="string")return t;var r=He(t,e);return _e(r)}function _e(t){if(t.length===1)return t[0];for(var e={},r=e,n=0;n<t.length-1;n++)n===t.length-2?r[t[n]]=t[n+1]:(r[t[n]]={},r=r[t[n]]);return e}function ae(t){var e;return(e=[]).concat.apply(e,J([],M(t),!1))}function Qe(t){return H(t)?t:[t]}function Te(t){return t===void 0?[]:Qe(t)}function Oe(t,e,r){var n,i;if(x(t))return t(e,r.data);var s={};try{for(var o=P(Object.keys(t)),f=o.next();!f.done;f=o.next()){var a=f.value,l=t[a];x(l)?s[a]=l(e,r.data):s[a]=l}}catch(u){n={error:u}}finally{try{f&&!f.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}function Ie(t){return!!(t instanceof Promise||t!==null&&(x(t)||typeof t=="object")&&x(t.then))}function qe(t){return t!==null&&typeof t=="object"&&"transition"in t&&typeof t.transition=="function"}function Pe(t,e,r,n){A||L(!!t,"Attempting to update undefined context");var i=t&&r.reduce(function(s,o){var f,a,l=o.assignment,u={state:n,action:o,_event:e},d={};if(x(l))d=l(s,e.data,u);else try{for(var c=P(Object.keys(l)),h=c.next();!h.done;h=c.next()){var v=h.value,w=l[v];d[v]=x(w)?w(s,e.data,u):w}}catch(S){f={error:S}}finally{try{h&&!h.done&&(a=c.return)&&a.call(c)}finally{if(f)throw f.error}}return Object.assign({},s,d)},t);return i}var L=function(){};A||(L=function(t,e){var r=t instanceof Error?t:void 0;if(!(!r&&t)&&console!==void 0){var n=["Warning: ".concat(e)];r&&n.push(r),console.warn.apply(console,n)}});function H(t){return Array.isArray(t)}function x(t){return typeof t=="function"}function U(t){return typeof t=="string"}function We(t,e){if(!!t)return U(t)?{type:oe,name:t,predicate:e?e[t]:void 0}:x(t)?{type:oe,name:t.name,predicate:t}:t}function Ye(t){try{return"subscribe"in t&&x(t.subscribe)}catch{return!1}}var z=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();Z={},Z[z]=function(){return this},Z[Symbol.observable]=function(){return this};function ue(t){return!!t&&"__xstatenode"in t}function Ze(t){return!!t&&typeof t.send=="function"}function Ne(t,e){return U(t)||typeof t=="number"?g({type:t},e):t}function N(t,e){if(!U(t)&&"$$type"in t&&t.$$type==="scxml")return t;var r=Ne(t);return g({name:r.type,data:r,$$type:"scxml",type:"external"},e)}function Be(t,e,r){if(!A){var n=t.stack?" Stacktrace was '".concat(t.stack,"'"):"";if(t===e)console.error("Missing onError handler for invocation '".concat(r,"', error was '").concat(t,"'.").concat(n));else{var i=e.stack?" Stacktrace was '".concat(e.stack,"'"):"";console.error("Missing onError handler and/or unhandled exception/promise rejection for invocation '".concat(r,"'. ")+"Original error: '".concat(t,"'. ").concat(n," Current error is '").concat(e,"'.").concat(i))}}}function Ve(t,e,r,n,i){var s=t.options.guards,o={state:i,cond:e,_event:n};if(e.type===oe)return((s==null?void 0:s[e.name])||e.predicate)(r,n.data,o);var f=s==null?void 0:s[e.type];if(!f)throw new Error("Guard '".concat(e.type,"' is not implemented on machine '").concat(t.id,"'."));return f(r,n.data,o)}function et(t){return typeof t=="string"?{type:t}:t}function B(t,e,r){var n=function(){},i=typeof t=="object",s=i?t:null;return{next:((i?t.next:t)||n).bind(s),error:((i?t.error:e)||n).bind(s),complete:((i?t.complete:r)||n).bind(s)}}var X=N({type:ze});function fe(t,e){return e&&e[t]||void 0}function Ae(t,e){var r;if(U(t)||typeof t=="number"){var n=fe(t,e);x(n)?r={type:t,exec:n}:n?r=n:r={type:t,exec:void 0}}else if(x(t))r={type:t.name||t.toString(),exec:t};else{var n=fe(t.type,e);if(x(n))r=g(g({},t),{exec:n});else if(n){var i=n.type||t.type;r=g(g(g({},n),t),{type:i})}else r=t}return r}var ce=function(t,e){if(!t)return[];var r=H(t)?t:[t];return r.map(function(n){return Ae(n,e)})};function tt(t){return{type:ie,_event:N(t.event)}}function nt(t,e,r,n){var i={_event:r},s=N(x(t.event)?t.event(e,r.data,i):t.event),o;if(U(t.delay)){var f=n&&n[t.delay];o=x(f)?f(e,r.data,i):f}else o=x(t.delay)?t.delay(e,r.data,i):t.delay;var a=x(t.to)?t.to(e,r.data,i):t.to;return g(g({},t),{to:a,_event:s,event:s.data,delay:o})}var rt=function(t,e,r){return g(g({},t),{value:U(t.expr)?t.expr:t.expr(e,r.data,{_event:r})})};function it(t,e,r){var n=x(t.activity)?t.activity(e,r.data):t.activity,i=typeof n=="string"?{id:n}:n,s={type:b.Stop,activity:i};return s}function le(t,e){var r="".concat(b.DoneInvoke,".").concat(t),n={type:r,data:e};return n.toString=function(){return r},n}function V(t,e){var r="".concat(b.ErrorPlatform,".").concat(t),n={type:r,data:e};return n.toString=function(){return r},n}var st=function(t){var e,r,n=[];try{for(var i=P(t),s=i.next();!s.done;s=i.next())for(var o=s.value,f=0;f<o.length;){if(o[f].type===we){n.push(o[f]),o.splice(f,1);continue}f++}}catch(a){e={error:a}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return n};function de(t,e,r,n,i,s,o){o===void 0&&(o=!1);var f=o?[]:st(i),a=f.length?Pe(r,n,f,e):r,l=o?[r]:void 0,u=[];function d(v){var w;switch(v.type){case ie:return tt(v);case se:var S=nt(v,a,n,t.options.delays);return A||L(!U(v.delay)||typeof S.delay=="number","No delay reference for delay expression '".concat(v.delay,"' was found on machine '").concat(t.id,"'")),s&&S.to!==F.Internal&&u.push(S),S;case me:{var y=rt(v,a,n);return s==null||s(y,a,n),y}case $e:{var _=v,m=(w=_.conds.find(function(Re){var W=We(Re.cond,t.options.guards);return!W||Ve(t,W,a,n,s?void 0:e)}))===null||w===void 0?void 0:w.actions;if(!m)return[];var R=M(de(t,e,a,n,[ce(Te(m),t.options.actions)],s,o),2),I=R[0],D=R[1];return a=D,l==null||l.push(a),I}case Ge:{var m=v.get(a,n.data);if(!m)return[];var E=M(de(t,e,a,n,[ce(Te(m),t.options.actions)],s,o),2),C=E[0],O=E[1];return a=O,l==null||l.push(a),C}case ge:{var y=it(v,a,n);return s==null||s(y,r,n),y}case we:{a=Pe(a,n,[v],s?void 0:e),l==null||l.push(a);break}default:var K=Ae(v,t.options.actions),q=K.exec;if(s)s(K,a,n);else if(q&&l){var ne=l.length-1;K=g(g({},K),{exec:function(Re){for(var W=[],re=1;re<arguments.length;re++)W[re-1]=arguments[re];q.apply(void 0,J([l[ne]],M(W),!1))}})}return K}}function c(v){var w,S,y=[];try{for(var _=P(v),m=_.next();!m.done;m=_.next()){var R=m.value,I=d(R);I&&(y=y.concat(I))}}catch(D){w={error:D}}finally{try{m&&!m.done&&(S=_.return)&&S.call(_)}finally{if(w)throw w.error}}return u.forEach(function(D){s(D,a,n)}),u.length=0,y}var h=ae(i.map(c));return[h,a]}var G=function(t,e){var r=e(t);return r};function ot(t){var e;return e={id:t,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},getSnapshot:function(){},toJSON:function(){return{id:t}}},e[z]=function(){return this},e}function at(t,e,r){var n=ot(e);if(n.deferred=!0,ue(t)){var i=n.state=G(void 0,function(){return(r?t.withContext(r):t).initialState});n.getSnapshot=function(){return i}}return n}function ut(t){try{return typeof t.send=="function"}catch{return!1}}function ft(t){return ut(t)&&"id"in t}function ct(t){var e;return g((e={subscribe:function(){return{unsubscribe:function(){}}},id:"anonymous",getSnapshot:function(){}},e[z]=function(){return this},e),t)}function lt(t){return J([],M(new Set(ae(J([],M(t.map(function(e){return e.ownEvents})),!1)))),!1)}function dt(t){return t===void 0&&(t=[]),t.reduce(function(e,r){return r.meta!==void 0&&(e[r.id]=r.meta),e},{})}function ht(t){return typeof t!="object"||t===null?!1:"value"in t&&"_event"in t}function vt(t,e){var r=t.exec,n=g(g({},t),{exec:r!==void 0?function(){return r(e.context,e.event,{action:t,state:e,_event:e._event})}:void 0});return n}var Ce=function(){function t(e){var r=this,n;this.actions=[],this.activities=be,this.meta={},this.events=[],this.value=e.value,this.context=e.context,this._event=e._event,this._sessionid=e._sessionid,this.event=this._event.data,this.historyValue=e.historyValue,this.history=e.history,this.actions=e.actions||[],this.activities=e.activities||be,this.meta=dt(e.configuration),this.events=e.events||[],this.matches=this.matches.bind(this),this.toStrings=this.toStrings.bind(this),this.configuration=e.configuration,this.transitions=e.transitions,this.children=e.children,this.done=!!e.done,this.tags=(n=Array.isArray(e.tags)?new Set(e.tags):e.tags)!==null&&n!==void 0?n:new Set,this.machine=e.machine,Object.defineProperty(this,"nextEvents",{get:function(){return lt(r.configuration)}})}return t.from=function(e,r){if(e instanceof t)return e.context!==r?new t({value:e.value,context:r,_event:e._event,_sessionid:null,historyValue:e.historyValue,history:e.history,actions:[],activities:e.activities,meta:{},events:[],configuration:[],transitions:[],children:{}}):e;var n=X;return new t({value:e,context:r,_event:n,_sessionid:null,historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[],configuration:[],transitions:[],children:{}})},t.create=function(e){return new t(e)},t.inert=function(e,r){if(e instanceof t){if(!e.actions.length)return e;var n=X;return new t({value:e.value,context:r,_event:n,_sessionid:null,historyValue:e.historyValue,history:e.history,activities:e.activities,configuration:e.configuration,transitions:[],children:{}})}return t.from(e,r)},t.prototype.toStrings=function(e,r){var n=this;if(e===void 0&&(e=this.value),r===void 0&&(r="."),U(e))return[e];var i=Object.keys(e);return i.concat.apply(i,J([],M(i.map(function(s){return n.toStrings(e[s],r).map(function(o){return s+r+o})})),!1))},t.prototype.toJSON=function(){var e=this;e.configuration,e.transitions;var r=e.tags;e.machine;var n=De(e,["configuration","transitions","tags","machine"]);return g(g({},n),{tags:Array.from(r)})},t.prototype.matches=function(e){return xe(e,this.value)},t.prototype.hasTag=function(e){return this.tags.has(e)},t.prototype.can=function(e){var r;A&&L(!!this.machine,"state.can(...) used outside of a machine-created State object; this will always return false.");var n=(r=this.machine)===null||r===void 0?void 0:r.getTransitionData(this,e);return!!(n!=null&&n.transitions.length)&&n.transitions.some(function(i){return i.target!==void 0||i.actions.length})},t}(),pt={deferEvents:!1},ke=function(){function t(e){this.processingEvent=!1,this.queue=[],this.initialized=!1,this.options=g(g({},pt),e)}return t.prototype.initialize=function(e){if(this.initialized=!0,e){if(!this.options.deferEvents){this.schedule(e);return}this.process(e)}this.flushEvents()},t.prototype.schedule=function(e){if(!this.initialized||this.processingEvent){this.queue.push(e);return}if(this.queue.length!==0)throw new Error("Event queue should be empty when it is not processing events");this.process(e),this.flushEvents()},t.prototype.clear=function(){this.queue=[]},t.prototype.flushEvents=function(){for(var e=this.queue.shift();e;)this.process(e),e=this.queue.shift()},t.prototype.process=function(e){this.processingEvent=!0;try{e()}catch(r){throw this.clear(),r}finally{this.processingEvent=!1}},t}(),he=new Map,yt=0,ee={bookId:function(){return"x:".concat(yt++)},register:function(t,e){return he.set(t,e),t},get:function(t){return he.get(t)},free:function(t){he.delete(t)}};function ve(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;A||console.warn("XState could not find a global object in this environment. Please let the maintainers know and raise an issue here: https://github.com/statelyai/xstate/issues")}function gt(){var t=ve();if(t&&"__xstate__"in t)return t.__xstate__}function wt(t){if(!!ve()){var e=gt();e&&e.register(t)}}function mt(t,e){e===void 0&&(e={});var r=t.initialState,n=new Set,i=[],s=!1,o=function(){if(!s){for(s=!0;i.length>0;){var l=i.shift();r=t.transition(r,l,a),n.forEach(function(u){return u.next(r)})}s=!1}},f=ct({id:e.id,send:function(l){i.push(l),o()},getSnapshot:function(){return r},subscribe:function(l,u,d){var c=B(l,u,d);return n.add(c),c.next(r),{unsubscribe:function(){n.delete(c)}}}}),a={parent:e.parent,self:f,id:e.id||"anonymous",observers:n};return r=t.start?t.start(a):r,f}var St={sync:!1,autoForward:!1},T;(function(t){t[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.Stopped=2]="Stopped"})(T||(T={}));var bt=function(){function t(e,r){r===void 0&&(r=t.defaultOptions);var n=this;this.machine=e,this.delayedEventsMap={},this.listeners=new Set,this.contextListeners=new Set,this.stopListeners=new Set,this.doneListeners=new Set,this.eventListeners=new Set,this.sendListeners=new Set,this.initialized=!1,this.status=T.NotStarted,this.children=new Map,this.forwardTo=new Set,this._outgoingQueue=[],this.init=this.start,this.send=function(u,d){if(H(u))return n.batch(u),n.state;var c=N(Ne(u,d));if(n.status===T.Stopped)return A||L(!1,'Event "'.concat(c.name,'" was sent to stopped service "').concat(n.machine.id,`". This service has already reached its final state, and will not transition.
Event: `).concat(JSON.stringify(c.data))),n.state;if(n.status!==T.Running&&!n.options.deferEvents)throw new Error('Event "'.concat(c.name,'" was sent to uninitialized service "').concat(n.machine.id,`". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.
Event: `).concat(JSON.stringify(c.data)));return n.scheduler.schedule(function(){n.forward(c);var h=n._nextState(c);n.update(h,c)}),n._state},this.sendTo=function(u,d,c){var h=n.parent&&(d===F.Parent||n.parent.id===d),v=h?n.parent:U(d)?n.children.get(d)||ee.get(d):Ze(d)?d:void 0;if(!v){if(!h)throw new Error("Unable to send event to child '".concat(d,"' from service '").concat(n.id,"'."));A||L(!1,"Service '".concat(n.id,"' has no parent: unable to send event ").concat(u.type));return}if("machine"in v){if(n.status!==T.Stopped||n.parent!==v||n.state.done){var w=g(g({},u),{name:u.name===Ke?"".concat(V(n.id)):u.name,origin:n.sessionId});!c&&n.machine.config.predictableActionArguments?n._outgoingQueue.push([v,w]):v.send(w)}}else!c&&n.machine.config.predictableActionArguments?n._outgoingQueue.push([v,u.data]):v.send(u.data)},this._exec=function(u,d,c,h){h===void 0&&(h=n.machine.options.actions);var v=u.exec||fe(u.type,h),w=x(v)?v:v?v.exec:u.exec;if(w)try{return w(d,c.data,n.machine.config.predictableActionArguments?{action:u,_event:c}:{action:u,state:n.state,_event:c})}catch(ne){throw n.parent&&n.parent.send({type:"xstate.error",data:ne}),ne}switch(u.type){case se:var S=u;if(typeof S.delay=="number"){n.defer(S);return}else S.to?n.sendTo(S._event,S.to,c===X):n.send(S._event);break;case je:n.cancel(u.sendId);break;case Me:{if(n.status!==T.Running)return;var y=u.activity;if(!n.machine.config.predictableActionArguments&&!n.state.activities[y.id||y.type])break;if(y.type===b.Invoke){var _=et(y.src),m=n.machine.options.services?n.machine.options.services[_.type]:void 0,R=y.id,I=y.data;A||L(!("forward"in y),"`forward` property is deprecated (found in invocation of '".concat(y.src,"' in in machine '").concat(n.machine.id,"'). ")+"Please use `autoForward` instead.");var D="autoForward"in y?y.autoForward:!!y.forward;if(!m){A||L(!1,"No service found for invocation '".concat(y.src,"' in machine '").concat(n.machine.id,"'."));return}var E=I?Oe(I,d,c):void 0;if(typeof m=="string")return;var C=x(m)?m(d,c.data,{data:E,src:_,meta:y.meta}):m;if(!C)return;var O=void 0;ue(C)&&(C=E?C.withContext(E):C,O={autoForward:D}),n.spawn(C,R,O)}else n.spawnActivity(y);break}case ge:{n.stopChild(u.activity.id);break}case me:var K=u.label,q=u.value;K?n.logger(K,q):n.logger(q);break;default:A||L(!1,"No implementation found for action type '".concat(u.type,"'"));break}};var i=g(g({},t.defaultOptions),r),s=i.clock,o=i.logger,f=i.parent,a=i.id,l=a!==void 0?a:e.id;this.id=l,this.logger=o,this.clock=s,this.parent=f,this.options=i,this.scheduler=new ke({deferEvents:this.options.deferEvents}),this.sessionId=ee.bookId()}return Object.defineProperty(t.prototype,"initialState",{get:function(){var e=this;return this._initialState?this._initialState:G(this,function(){return e._initialState=e.machine.initialState,e._initialState})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return A||L(this.status!==T.NotStarted,"Attempted to read state from uninitialized service '".concat(this.id,"'. Make sure the service is started first.")),this._state},enumerable:!1,configurable:!0}),t.prototype.execute=function(e,r){var n,i;try{for(var s=P(e.actions),o=s.next();!o.done;o=s.next()){var f=o.value;this.exec(f,e,r)}}catch(a){n={error:a}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}},t.prototype.update=function(e,r){var n,i,s,o,f,a,l,u,d=this;if(e._sessionid=this.sessionId,this._state=e,(!this.machine.config.predictableActionArguments||r===X)&&this.options.execute)this.execute(this.state);else for(var c=void 0;c=this._outgoingQueue.shift();)c[0].send(c[1]);if(this.children.forEach(function(O){d.state.children[O.id]=O}),this.devTools&&this.devTools.send(r.data,e),e.event)try{for(var h=P(this.eventListeners),v=h.next();!v.done;v=h.next()){var w=v.value;w(e.event)}}catch(O){n={error:O}}finally{try{v&&!v.done&&(i=h.return)&&i.call(h)}finally{if(n)throw n.error}}try{for(var S=P(this.listeners),y=S.next();!y.done;y=S.next()){var w=y.value;w(e,e.event)}}catch(O){s={error:O}}finally{try{y&&!y.done&&(o=S.return)&&o.call(S)}finally{if(s)throw s.error}}try{for(var _=P(this.contextListeners),m=_.next();!m.done;m=_.next()){var R=m.value;R(this.state.context,this.state.history?this.state.history.context:void 0)}}catch(O){f={error:O}}finally{try{m&&!m.done&&(a=_.return)&&a.call(_)}finally{if(f)throw f.error}}if(this.state.done){var I=e.configuration.find(function(O){return O.type==="final"&&O.parent===d.machine}),D=I&&I.doneData?Oe(I.doneData,e.context,r):void 0;try{for(var E=P(this.doneListeners),C=E.next();!C.done;C=E.next()){var w=C.value;w(le(this.id,D))}}catch(O){l={error:O}}finally{try{C&&!C.done&&(u=E.return)&&u.call(E)}finally{if(l)throw l.error}}this._stop(),this._stopChildren()}},t.prototype.onTransition=function(e){return this.listeners.add(e),this.status===T.Running&&e(this.state,this.state.event),this},t.prototype.subscribe=function(e,r,n){var i=this,s=B(e,r,n);this.listeners.add(s.next),this.status!==T.NotStarted&&s.next(this.state);var o=function(){i.doneListeners.delete(o),i.stopListeners.delete(o),s.complete()};return this.status===T.Stopped?s.complete():(this.onDone(o),this.onStop(o)),{unsubscribe:function(){i.listeners.delete(s.next),i.doneListeners.delete(o),i.stopListeners.delete(o)}}},t.prototype.onEvent=function(e){return this.eventListeners.add(e),this},t.prototype.onSend=function(e){return this.sendListeners.add(e),this},t.prototype.onChange=function(e){return this.contextListeners.add(e),this},t.prototype.onStop=function(e){return this.stopListeners.add(e),this},t.prototype.onDone=function(e){return this.doneListeners.add(e),this},t.prototype.off=function(e){return this.listeners.delete(e),this.eventListeners.delete(e),this.sendListeners.delete(e),this.stopListeners.delete(e),this.doneListeners.delete(e),this.contextListeners.delete(e),this},t.prototype.start=function(e){var r=this;if(this.status===T.Running)return this;this.machine._init(),ee.register(this.sessionId,this),this.initialized=!0,this.status=T.Running;var n=e===void 0?this.initialState:G(this,function(){return ht(e)?r.machine.resolveState(e):r.machine.resolveState(Ce.from(e,r.machine.context))});return this.options.devTools&&this.attachDev(),this.scheduler.initialize(function(){r.update(n,X)}),this},t.prototype._stopChildren=function(){this.children.forEach(function(e){x(e.stop)&&e.stop()}),this.children.clear()},t.prototype._stop=function(){var e,r,n,i,s,o,f,a,l,u;try{for(var d=P(this.listeners),c=d.next();!c.done;c=d.next()){var h=c.value;this.listeners.delete(h)}}catch(E){e={error:E}}finally{try{c&&!c.done&&(r=d.return)&&r.call(d)}finally{if(e)throw e.error}}try{for(var v=P(this.stopListeners),w=v.next();!w.done;w=v.next()){var h=w.value;h(),this.stopListeners.delete(h)}}catch(E){n={error:E}}finally{try{w&&!w.done&&(i=v.return)&&i.call(v)}finally{if(n)throw n.error}}try{for(var S=P(this.contextListeners),y=S.next();!y.done;y=S.next()){var h=y.value;this.contextListeners.delete(h)}}catch(E){s={error:E}}finally{try{y&&!y.done&&(o=S.return)&&o.call(S)}finally{if(s)throw s.error}}try{for(var _=P(this.doneListeners),m=_.next();!m.done;m=_.next()){var h=m.value;this.doneListeners.delete(h)}}catch(E){f={error:E}}finally{try{m&&!m.done&&(a=_.return)&&a.call(_)}finally{if(f)throw f.error}}if(!this.initialized)return this;this.initialized=!1,this.status=T.Stopped,this._initialState=void 0;try{for(var R=P(Object.keys(this.delayedEventsMap)),I=R.next();!I.done;I=R.next()){var D=I.value;this.clock.clearTimeout(this.delayedEventsMap[D])}}catch(E){l={error:E}}finally{try{I&&!I.done&&(u=R.return)&&u.call(R)}finally{if(l)throw l.error}}this.scheduler.clear(),this.scheduler=new ke({deferEvents:this.options.deferEvents})},t.prototype.stop=function(){var e=this,r=this.scheduler;return this._stop(),r.schedule(function(){var n=N({type:"xstate.stop"}),i=G(e,function(){var s=ae(J([],M(e.state.configuration),!1).sort(function(u,d){return d.order-u.order}).map(function(u){return ce(u.onExit,e.machine.options.actions)})),o=M(de(e.machine,e.state,e.state.context,n,[s],e.machine.config.predictableActionArguments?e._exec:void 0,e.machine.config.predictableActionArguments||e.machine.config.preserveActionOrder),2),f=o[0],a=o[1],l=new Ce({value:e.state.value,context:a,_event:n,_sessionid:e.sessionId,historyValue:void 0,history:e.state,actions:f.filter(function(u){return u.type!==ie&&(u.type!==se||!!u.to&&u.to!==F.Internal)}),activities:{},events:[],configuration:[],transitions:[],children:{},done:e.state.done,tags:e.state.tags,machine:e.machine});return l.changed=!0,l});e.update(i,n),e._stopChildren(),ee.free(e.sessionId)}),this},t.prototype.batch=function(e){var r=this;if(this.status===T.NotStarted&&this.options.deferEvents)A||L(!1,"".concat(e.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,`" and are deferred. Make sure .start() is called for this service.
Event: `).concat(JSON.stringify(event)));else if(this.status!==T.Running)throw new Error("".concat(e.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,'". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.'));if(!!e.length){var n=!!this.machine.config.predictableActionArguments&&this._exec;this.scheduler.schedule(function(){var i,s,o=r.state,f=!1,a=[],l=function(h){var v=N(h);r.forward(v),o=G(r,function(){return r.machine.transition(o,v,void 0,n||void 0)}),a.push.apply(a,J([],M(r.machine.config.predictableActionArguments?o.actions:o.actions.map(function(w){return vt(w,o)})),!1)),f=f||!!o.changed};try{for(var u=P(e),d=u.next();!d.done;d=u.next()){var c=d.value;l(c)}}catch(h){i={error:h}}finally{try{d&&!d.done&&(s=u.return)&&s.call(u)}finally{if(i)throw i.error}}o.changed=f,o.actions=a,r.update(o,N(e[e.length-1]))})}},t.prototype.sender=function(e){return this.send.bind(this,e)},t.prototype._nextState=function(e,r){var n=this;r===void 0&&(r=!!this.machine.config.predictableActionArguments&&this._exec);var i=N(e);if(i.name.indexOf(Se)===0&&!this.state.nextEvents.some(function(o){return o.indexOf(Se)===0}))throw i.data.data;var s=G(this,function(){return n.machine.transition(n.state,i,void 0,r||void 0)});return s},t.prototype.nextState=function(e){return this._nextState(e,!1)},t.prototype.forward=function(e){var r,n;try{for(var i=P(this.forwardTo),s=i.next();!s.done;s=i.next()){var o=s.value,f=this.children.get(o);if(!f)throw new Error("Unable to forward event '".concat(e,"' from interpreter '").concat(this.id,"' to nonexistant child '").concat(o,"'."));f.send(e)}}catch(a){r={error:a}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}},t.prototype.defer=function(e){var r=this;this.delayedEventsMap[e.id]=this.clock.setTimeout(function(){e.to?r.sendTo(e._event,e.to,!0):r.send(e._event)},e.delay)},t.prototype.cancel=function(e){this.clock.clearTimeout(this.delayedEventsMap[e]),delete this.delayedEventsMap[e]},t.prototype.exec=function(e,r,n){n===void 0&&(n=this.machine.options.actions),this._exec(e,r.context,r._event,n)},t.prototype.removeChild=function(e){var r;this.children.delete(e),this.forwardTo.delete(e),(r=this.state)===null||r===void 0||delete r.children[e]},t.prototype.stopChild=function(e){var r=this.children.get(e);!r||(this.removeChild(e),x(r.stop)&&r.stop())},t.prototype.spawn=function(e,r,n){if(this.status!==T.Running)return at(e,r);if(Ie(e))return this.spawnPromise(Promise.resolve(e),r);if(x(e))return this.spawnCallback(e,r);if(ft(e))return this.spawnActor(e,r);if(Ye(e))return this.spawnObservable(e,r);if(ue(e))return this.spawnMachine(e,g(g({},n),{id:r}));if(qe(e))return this.spawnBehavior(e,r);throw new Error('Unable to spawn entity "'.concat(r,'" of type "').concat(typeof e,'".'))},t.prototype.spawnMachine=function(e,r){var n=this;r===void 0&&(r={});var i=new t(e,g(g({},this.options),{parent:this,id:r.id||e.id})),s=g(g({},St),r);s.sync&&i.onTransition(function(f){n.send(Je,{state:f,id:i.id})});var o=i;return this.children.set(i.id,o),s.autoForward&&this.forwardTo.add(i.id),i.onDone(function(f){n.removeChild(i.id),n.send(N(f,{origin:i.id}))}).start(),o},t.prototype.spawnBehavior=function(e,r){var n=mt(e,{id:r,parent:this});return this.children.set(r,n),n},t.prototype.spawnPromise=function(e,r){var n,i=this,s=!1,o;e.then(function(a){s||(o=a,i.removeChild(r),i.send(N(le(r,a),{origin:r})))},function(a){if(!s){i.removeChild(r);var l=V(r,a);try{i.send(N(l,{origin:r}))}catch(u){Be(a,u,r),i.devTools&&i.devTools.send(l,i.state),i.machine.strict&&i.stop()}}});var f=(n={id:r,send:function(){},subscribe:function(a,l,u){var d=B(a,l,u),c=!1;return e.then(function(h){c||(d.next(h),!c&&d.complete())},function(h){c||d.error(h)}),{unsubscribe:function(){return c=!0}}},stop:function(){s=!0},toJSON:function(){return{id:r}},getSnapshot:function(){return o}},n[z]=function(){return this},n);return this.children.set(r,f),f},t.prototype.spawnCallback=function(e,r){var n,i=this,s=!1,o=new Set,f=new Set,a,l=function(c){a=c,f.forEach(function(h){return h(c)}),!s&&i.send(N(c,{origin:r}))},u;try{u=e(l,function(c){o.add(c)})}catch(c){this.send(V(r,c))}if(Ie(u))return this.spawnPromise(u,r);var d=(n={id:r,send:function(c){return o.forEach(function(h){return h(c)})},subscribe:function(c){var h=B(c);return f.add(h.next),{unsubscribe:function(){f.delete(h.next)}}},stop:function(){s=!0,x(u)&&u()},toJSON:function(){return{id:r}},getSnapshot:function(){return a}},n[z]=function(){return this},n);return this.children.set(r,d),d},t.prototype.spawnObservable=function(e,r){var n,i=this,s,o=e.subscribe(function(a){s=a,i.send(N(a,{origin:r}))},function(a){i.removeChild(r),i.send(N(V(r,a),{origin:r}))},function(){i.removeChild(r),i.send(N(le(r),{origin:r}))}),f=(n={id:r,send:function(){},subscribe:function(a,l,u){return e.subscribe(a,l,u)},stop:function(){return o.unsubscribe()},getSnapshot:function(){return s},toJSON:function(){return{id:r}}},n[z]=function(){return this},n);return this.children.set(r,f),f},t.prototype.spawnActor=function(e,r){return this.children.set(r,e),e},t.prototype.spawnActivity=function(e){var r=this.machine.options&&this.machine.options.activities?this.machine.options.activities[e.type]:void 0;if(!r){A||L(!1,"No implementation found for activity '".concat(e.type,"'"));return}var n=r(this.state.context,e);this.spawnEffect(e.id,n)},t.prototype.spawnEffect=function(e,r){var n;this.children.set(e,(n={id:e,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},stop:r||void 0,getSnapshot:function(){},toJSON:function(){return{id:e}}},n[z]=function(){return this},n))},t.prototype.attachDev=function(){var e=ve();if(this.options.devTools&&e){if(e.__REDUX_DEVTOOLS_EXTENSION__){var r=typeof this.options.devTools=="object"?this.options.devTools:void 0;this.devTools=e.__REDUX_DEVTOOLS_EXTENSION__.connect(g(g({name:this.id,autoPause:!0,stateSanitizer:function(n){return{value:n.value,context:n.context,actions:n.actions}}},r),{features:g({jump:!1,skip:!1},r?r.features:void 0)}),this.machine),this.devTools.init(this.state)}wt(this)}},t.prototype.toJSON=function(){return{id:this.id}},t.prototype[z]=function(){return this},t.prototype.getSnapshot=function(){return this.status===T.NotStarted?this.initialState:this._state},t.defaultOptions={execute:!0,deferEvents:!0,clock:{setTimeout:function(e,r){return setTimeout(e,r)},clearTimeout:function(e){return clearTimeout(e)}},logger:console.log.bind(console),devTools:!1},t.interpret=Q,t}();function Q(t,e){var r=new bt(t,e);return r}const xt=()=>typeof window<"u",te=t=>!t||!t.accessToken.value||!t.refreshToken.value||!t.accessToken.expiresAt||!t.user?null:{accessToken:t.accessToken.value,accessTokenExpiresIn:(t.accessToken.expiresAt.getTime()-Date.now())/1e3,refreshToken:t.refreshToken.value,user:t.user},$=({accessToken:t,isError:e,user:r,error:n})=>e?{session:null,error:n}:r&&t?{session:{accessToken:t,accessTokenExpiresIn:0,refreshToken:"",user:r},error:null}:{session:null,error:null};class Et{constructor({url:e,autoRefreshToken:r=!0,autoSignIn:n=!0,autoLogin:i,clientStorage:s,clientStorageType:o,clientStorageGetter:f,clientStorageSetter:a,refreshIntervalTime:l,start:u=!0}){pe(this,"_client");pe(this,"url");var d;this.url=e,this._client=new p.AuthClient({backendUrl:e,clientUrl:typeof window<"u"&&((d=window.location)==null?void 0:d.origin)||"",autoRefreshToken:r,autoSignIn:typeof i=="boolean"?i:n,start:u,clientStorage:s,clientStorageType:o,clientStorageGetter:f,clientStorageSetter:a,refreshIntervalTime:l})}async signUp(e){const r=await this.waitUntilReady(),{email:n,options:i}=e;return"securityKey"in e?$(await p.signUpEmailSecurityKeyPromise(r,n,i)):$(await p.signUpEmailPasswordPromise(r,n,e.password,i))}async signIn(e){const r=await this.waitUntilReady();if(!e){const n=await p.signInAnonymousPromise(r);return{...$(n),mfa:null}}if("provider"in e){const{provider:n,options:i}=e,s=p.encodeQueryParameters(`${this._client.backendUrl}/signin/provider/${n}`,p.rewriteRedirectTo(this._client.clientUrl,i));return xt()&&(window.location.href=s),{providerUrl:s,provider:n,session:null,mfa:null,error:null}}if("email"in e&&"password"in e){const n=await p.signInEmailPasswordPromise(r,e.email,e.password);return n.needsEmailVerification?{session:null,mfa:null,error:p.EMAIL_NEEDS_VERIFICATION}:n.needsMfaOtp?{session:null,mfa:n.mfa,error:null}:{...$(n),mfa:null}}if("email"in e&&"securityKey"in e){if(e.securityKey!==!0)throw Error("securityKey must be true");const n=await p.signInEmailSecurityKeyPromise(r,e.email);return{...$(n),mfa:null}}if("email"in e){const{email:n,options:i}=e,{error:s}=await p.signInEmailPasswordlessPromise(r,n,i);return{session:null,mfa:null,error:s}}if("phoneNumber"in e&&"otp"in e){const n=await p.signInSmsPasswordlessOtpPromise(r,e.phoneNumber,e.otp);return{...$(n),mfa:null}}if("phoneNumber"in e){const{error:n}=await p.signInSmsPasswordlessPromise(r,e.phoneNumber,e.options);return{error:n,mfa:null,session:null}}if("otp"in e){const n=await p.signInMfaTotpPromise(r,e.otp,e.ticket);return{...$(n),mfa:null}}return{error:p.INVALID_SIGN_IN_METHOD,mfa:null,session:null}}async signOut(e){const r=await this.waitUntilReady(),{error:n}=await p.signOutPromise(r,e==null?void 0:e.all);return{error:n}}async resetPassword({email:e,options:r}){const n=Q(p.createResetPasswordMachine(this._client)).start(),{error:i}=await p.resetPasswordPromise(n,e,r);return{error:i}}async changePassword({newPassword:e,ticket:r}){const n=Q(p.createChangePasswordMachine(this._client)).start(),{error:i}=await p.changePasswordPromise(n,e,r);return{error:i}}async sendVerificationEmail({email:e,options:r}){const n=Q(p.createSendVerificationEmailMachine(this._client)).start(),{error:i}=await p.sendVerificationEmailPromise(n,e,r);return{error:i}}async changeEmail({newEmail:e,options:r}){const n=Q(p.createChangeEmailMachine(this._client)).start(),{error:i}=await p.changeEmailPromise(n,e,r);return{error:i}}async deanonymize(e){const r=await this.waitUntilReady();if(e.signInMethod==="passwordless"){if(e.connection==="email"){const{error:n}=await p.signInEmailPasswordlessPromise(r,e.email,e.options);return{error:n}}if(e.connection==="sms"){const{error:n}=await p.signInSmsPasswordlessPromise(r,e.phoneNumber,e.options);return{error:n}}}if(e.signInMethod==="email-password"){const{error:n}=await p.signUpEmailPasswordPromise(r,e.email,e.password,e.options);return{error:n}}throw Error("Unknown deanonymization method")}async addSecurityKey(e){const{error:r,key:n}=await p.addSecurityKeyPromise(this._client,e);return{error:r,key:n}}onTokenChanged(e){const r=n=>n.onTransition(({event:i,context:s})=>{i.type==="TOKEN_CHANGED"&&e(te(s))});if(this._client.interpreter){const n=r(this._client.interpreter);return()=>n.stop()}else return this._client.onStart(n=>{r(n.interpreter)}),()=>{console.log("onTokenChanged was added before the interpreter started. Cannot unsubscribe listener.")}}onAuthStateChanged(e){const r=n=>n.onTransition(({event:i,context:s})=>{(i.type==="SIGNED_IN"||i.type==="SIGNED_OUT")&&e(i.type,te(s))});if(this._client.interpreter){const n=r(this._client.interpreter);return()=>n.stop()}else return this._client.onStart(n=>{r(n.interpreter)}),()=>{console.log("onAuthStateChanged was added before the interpreter started. Cannot unsubscribe listener.")}}isAuthenticated(){var e;return!!((e=this._client.interpreter)!=null&&e.getSnapshot().matches({authentication:"signedIn"}))}async isAuthenticatedAsync(){return(await this.waitUntilReady()).getSnapshot().matches({authentication:"signedIn"})}getAuthenticationStatus(){var r;const e=((r=this.client.interpreter)==null?void 0:r.getSnapshot().context.importTokenAttempts)||0;return this.isReady()?{isAuthenticated:this.isAuthenticated(),isLoading:!1,connectionAttempts:e}:{isAuthenticated:!1,isLoading:!0,connectionAttempts:e}}getJWTToken(){return this.getAccessToken()}getAccessToken(){var e,r;return(r=(e=this._client.interpreter)==null?void 0:e.getSnapshot().context.accessToken.value)!=null?r:void 0}getDecodedAccessToken(){const e=this.getAccessToken();return e?Ue(e):null}getHasuraClaims(){var e;return((e=this.getDecodedAccessToken())==null?void 0:e["https://hasura.io/jwt/claims"])||null}getHasuraClaim(e){var r;return((r=this.getHasuraClaims())==null?void 0:r[e.startsWith("x-hasura-")?e:`x-hasura-${e}`])||null}async refreshSession(e){try{const r=await this.waitUntilReady();return new Promise(n=>{const i=e||r.getSnapshot().context.refreshToken.value;if(!i)return n({session:null,error:p.NO_REFRESH_TOKEN});const{changed:s}=r.send("TRY_TOKEN",{token:i});if(!s)return n({session:null,error:p.TOKEN_REFRESHER_RUNNING_ERROR});r.onTransition(o=>{o.matches({token:{idle:"error"}})?n({session:null,error:p.INVALID_REFRESH_TOKEN}):o.event.type==="TOKEN_CHANGED"&&n({session:te(o.context),error:null})})})}catch(r){return{session:null,error:r.message}}}getSession(){var e,r;return te((r=(e=this._client.interpreter)==null?void 0:e.getSnapshot())==null?void 0:r.context)}getUser(){var e,r,n;return((n=(r=(e=this._client.interpreter)==null?void 0:e.getSnapshot())==null?void 0:r.context)==null?void 0:n.user)||null}waitUntilReady(){const r=this._client.interpreter;if(!r)throw Error("Auth interpreter not set");return r.getSnapshot().hasTag("loading")?new Promise((n,i)=>{let s=setTimeout(()=>i(`The state machine is not yet ready after ${15} seconds.`),15e3);r.onTransition(o=>{if(!o.hasTag("loading"))return clearTimeout(s),n(r)})}):Promise.resolve(r)}isReady(){var e,r;return!((r=(e=this._client.interpreter)==null?void 0:e.getSnapshot())!=null&&r.hasTag("loading"))}get client(){return this._client}}k.HasuraAuthClient=Et,Object.defineProperties(k,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=hasura-auth-js.umd.js.map
